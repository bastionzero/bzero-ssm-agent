# spec:
# https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html
version: 0.2
env:
  variables:
    TZ: "America/New_York date"
    ReleaseDir: bzero-release
  git-credential-helper: yes
phases:
  install:
    runtime-versions:
      golang: 1.14
  pre_build:
    commands:
      - echo Pre-Build started...
      - git fetch --tags
      - LatestTag=$(git describe --tags --abbrev=0)
      - grep -q 'bzero-' <<< $LatestTag && echo "Tag is valid" || (echo "Tag $LatestTag is invalid" && exit 1)
      - git checkout $LatestTag
      - LatestVersion=$(echo $LatestTag | sed 's/bzero-//g' )
      - echo $LatestVersion > VERSION
  build:
    commands:
      - echo Build started...
      - make bzero-release
  post_build:
    commands:
      - echo Post build started...
      - echo Copying all files to $LatestVersion folder...
      - mkdir -p $ReleaseDir/$LatestVersion/x86_64
      - mkdir -p $ReleaseDir/$LatestVersion/arm64
      - cp -a bin/VERSION $ReleaseDir/$LatestVersion
      - cp -a bin/debian_amd64/bzero-ssm-agent.deb $ReleaseDir/$LatestVersion
      - cp -a bin/debian_amd64/bzero-ssm-agent.deb $ReleaseDir/$LatestVersion/x86_64
      - cp -a bin/debian_arm64/bzero-ssm-agent.deb $ReleaseDir/$LatestVersion/arm64
      - cp -a bin/linux_amd64/bzero-ssm-agent.rpm $ReleaseDir/$LatestVersion
      - cp -a bin/linux_amd64/bzero-ssm-agent.rpm $ReleaseDir/$LatestVersion/x86_64
      - cp -a bin/linux_arm64/bzero-ssm-agent.rpm $ReleaseDir/$LatestVersion/arm64
artifacts:
  files:
    - "**/*"
  base-directory: $ReleaseDir
  name: release
